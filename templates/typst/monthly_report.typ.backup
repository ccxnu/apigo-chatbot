// Monthly Analytics Report Template
// Variables passed via --input flags using sys.inputs

// Helper function to get input values
#let get(key, default: "") = {
  if key in sys.inputs {
    sys.inputs.at(key)
  } else {
    default
  }
}

// Helper to parse JSON arrays (for complex data structures)
#let parse-json(json-str) = {
  if json-str == "" or json-str == none {
    ()
  } else {
    // Typst will parse this natively
    json(json-str)
  }
}

#set document(
  title: "Reporte Mensual - " + get("month_year"),
  author: "ISTS Chatbot",
  date: datetime.today()
)

#set page(
  paper: "a4",
  margin: (x: 2.5cm, y: 2cm),
  numbering: "1 / 1",
  number-align: center,
  header: align(right)[
    #text(size: 9pt, fill: gray)[
      Reporte de Analíticas del Chatbot
    ]
  ],
  footer: align(center)[
    #line(length: 100%, stroke: 0.5pt + gray)
    #text(size: 9pt, fill: gray)[
      Instituto Superior Tecnológico Sudamericano · #counter(page).display("1 / 1")
    ]
  ]
)

#set text(
  font: "Arial",
  size: 11pt,
  lang: "es"
)

#set heading(numbering: "1.1")

// Title page
#align(center)[
  #v(3cm)
  // TODO: Add logo.png to templates/typst directory
  // #image("logo.png", width: 40%)
  #text(size: 20pt, weight: "bold", fill: blue.darken(30%))[
    INSTITUTO SUPERIOR TECNOLÓGICO SUDAMERICANO
  ]
  #v(1.5cm)
  #text(size: 24pt, weight: "bold")[
    Reporte Mensual de Analíticas
  ]
  #v(0.5cm)
  #text(size: 18pt)[
    Chatbot Institucional
  ]
  #v(0.5cm)
  #text(size: 16pt, fill: blue.darken(30%))[
    #get("month_year")
  ]
  #v(2cm)
  #text(size: 12pt)[
    Generado: #get("generated_date")
  ]
]

#pagebreak()

// Table of contents
#outline(
  title: "Índice",
  indent: auto
)

#pagebreak()

// ============================================
// EXECUTIVE SUMMARY
// ============================================

= Resumen Ejecutivo

Este reporte presenta las métricas clave del sistema de chatbot del Instituto Superior Tecnológico Sudamericano para el período de *#get("month_year")*.

== Métricas Principales

#grid(
  columns: (1fr, 1fr),
  gutter: 1em,

  // Cost Card
  box(
    fill: blue.lighten(90%),
    inset: 1em,
    radius: 5pt,
    width: 100%,
  )[
    #text(size: 10pt, fill: gray)[*Costo Total*]
    #v(0.3em)
    #text(size: 20pt, weight: "bold", fill: blue.darken(30%))[
      $#get("cost_this_month")
    ]
    #v(0.2em)
    #text(size: 9pt, fill: gray)[
      #if get("cost_change") != "" and get("cost_change") != "0" [
        #if float(get("cost_change")) > 0 [
          ↑ #get("cost_change")% vs mes anterior
        ] else [
          ↓ #get("cost_change")% vs mes anterior
        ]
      ]
    ]
  ],

  // Active Users Card
  box(
    fill: green.lighten(90%),
    inset: 1em,
    radius: 5pt,
    width: 100%,
  )[
    #text(size: 10pt, fill: gray)[*Usuarios Activos*]
    #v(0.3em)
    #text(size: 20pt, weight: "bold", fill: green.darken(30%))[
      #get("active_users_this_month")
    ]
    #v(0.2em)
    #text(size: 9pt, fill: gray)[
      #get("new_users_this_month") nuevos usuarios
    ]
  ],
)

#v(1em)

#grid(
  columns: (1fr, 1fr),
  gutter: 1em,

  // Conversations Card
  box(
    fill: orange.lighten(90%),
    inset: 1em,
    radius: 5pt,
    width: 100%,
  )[
    #text(size: 10pt, fill: gray)[*Conversaciones*]
    #v(0.3em)
    #text(size: 20pt, weight: "bold", fill: orange.darken(30%))[
      #get("conversations_this_month")
    ]
    #v(0.2em)
    #text(size: 9pt, fill: gray)[
      #get("avg_messages_per_conversation") mensajes promedio
    ]
  ],

  // Tokens Card
  box(
    fill: purple.lighten(90%),
    inset: 1em,
    radius: 5pt,
    width: 100%,
  )[
    #text(size: 10pt, fill: gray)[*Tokens Utilizados*]
    #v(0.3em)
    #text(size: 20pt, weight: "bold", fill: purple.darken(30%))[
      #get("tokens_this_month")
    ]
    #v(0.2em)
    #text(size: 9pt, fill: gray)[
      $#get("cost_per_conversation") por conversación
    ]
  ],
)

#pagebreak()

// ============================================
// COST ANALYSIS
// ============================================

= Análisis de Costos

== Desglose de Costos

El costo total del mes fue de *$#get("cost_this_month")*, distribuido de la siguiente manera:

#table(
  columns: (2fr, 1fr, 1fr),
  align: (left, right, right),
  inset: 10pt,
  stroke: 0.5pt + gray,
  table.header(
    [*Concepto*], [*Costo*], [*Porcentaje*]
  ),

  [Costo LLM (Generación)], [$#get("llm_cost")], [#get("llm_cost_percent")%],
  [Costo Embeddings], [$#get("embedding_cost")], [#get("embedding_cost_percent")%],
  table.cell(fill: gray.lighten(80%), [*Total*]),
  table.cell(fill: gray.lighten(80%), [*$#get("cost_this_month")*]),
  table.cell(fill: gray.lighten(80%), [*100%*]),
)

== Detalles de Tokens

#table(
  columns: (2fr, 1fr, 1fr),
  align: (left, right, right),
  inset: 10pt,
  stroke: 0.5pt + gray,
  table.header(
    [*Tipo*], [*Cantidad*], [*Costo Unitario*]
  ),

  [Tokens de Entrada (Prompt)], [#get("prompt_tokens")], [$0.50/M],
  [Tokens de Salida (Completion)], [#get("completion_tokens")], [$1.50/M],
  [Tokens de Embeddings], [#get("embedding_tokens")], [$0.13/M],
  table.cell(fill: gray.lighten(80%), [*Total Tokens*]),
  table.cell(fill: gray.lighten(80%), [*#get("total_tokens")*]),
  table.cell(fill: gray.lighten(80%), []),
)

== Métricas de Eficiencia

- *Costo por Conversación:* $#get("cost_per_conversation")
- *Tokens Promedio por Conversación:* #get("avg_tokens_per_conversation")
- *Costo por Usuario Activo:* $#get("cost_per_active_user")

#if get("cost_projection") != "" [
== Proyección de Fin de Mes

Basado en el uso actual, el costo estimado para fin de mes es de *$#get("cost_projection")*.
]

#pagebreak()

// ============================================
// USER ACTIVITY
// ============================================

= Actividad de Usuarios

== Estadísticas Generales

#table(
  columns: (2fr, 1fr),
  align: (left, right),
  inset: 10pt,
  stroke: 0.5pt + gray,

  [*Total de Usuarios (Histórico)*], [#get("total_users")],
  [*Usuarios Activos este Mes*], [#get("active_users_this_month")],
  [*Usuarios Nuevos*], [#get("new_users_this_month")],
  [*Usuarios Recurrentes*], [#get("returning_users_this_month")],
  [*Tasa de Retención*], [#get("retention_rate")%],
)

== Usuarios por Rol

#table(
  columns: (2fr, 1fr, 1fr),
  align: (left, right, right),
  inset: 10pt,
  stroke: 0.5pt + gray,
  table.header(
    [*Rol*], [*Cantidad*], [*Porcentaje*]
  ),

  [Estudiantes], [#get("students_count")], [#get("students_percent")%],
  [Docentes], [#get("professors_count")], [#get("professors_percent")%],
  [Externos], [#get("external_count")], [#get("external_percent")%],
)

== Nivel de Participación

- *Mensajes Promedio por Usuario:* #get("avg_messages_per_user")
- *Sesiones Promedio por Usuario:* #get("avg_sessions_per_user")
- *Duración Promedio de Sesión:* #get("avg_session_duration") minutos

#let top_users = parse-json(get("top_users_json", default: "[]"))
#if top_users.len() > 0 [
== Usuarios Más Activos (Top 10)

#table(
  columns: (1fr, 2fr, 1fr),
  align: (center, left, right),
  inset: 8pt,
  stroke: 0.5pt + gray,
  table.header(
    [*#*], [*Usuario*], [*Mensajes*]
  ),
  ..for (index, user) in top_users.enumerate() {
    ([#(index + 1)], [#user.name], [#str(user.message_count)])
  }
)
]

#pagebreak()

// ============================================
// CONVERSATIONS
// ============================================

= Análisis de Conversaciones

== Volumen de Conversaciones

#table(
  columns: (2fr, 1fr),
  align: (left, right),
  inset: 10pt,
  stroke: 0.5pt + gray,

  [*Total de Conversaciones (Histórico)*], [#get("total_conversations")],
  [*Conversaciones este Mes*], [#get("conversations_this_month")],
  [*Conversaciones Activas*], [#get("active_conversations")],
  [*Promedio de Mensajes por Conversación*], [#get("avg_messages_per_conversation")],
)

== Intervención del Administrador

#box(
  fill: yellow.lighten(80%),
  inset: 1em,
  radius: 5pt,
  width: 100%,
)[
  *Tasa de Intervención:* #get("admin_intervention_rate")%

  De #get("conversations_this_month") conversaciones este mes, #get("conversations_with_admin_help") requirieron asistencia del administrador.

  #let intervention = float(get("admin_intervention_rate", default: "0"))
  #if intervention > 15.0 [
    ⚠ *Alerta:* La tasa de intervención es alta. Considere revisar y mejorar el contenido de la base de conocimientos.
  ]
]

== Estado de Conversaciones

#table(
  columns: (2fr, 1fr),
  align: (left, right),
  inset: 10pt,
  stroke: 0.5pt + gray,

  [*Conversaciones Bloqueadas*], [#get("blocked_conversations")],
  [*Conversaciones Temporales*], [#get("temporary_conversations")],
)

#pagebreak()

// ============================================
// MESSAGES
// ============================================

= Análisis de Mensajes

== Volumen de Mensajes

#table(
  columns: (2fr, 1fr),
  align: (left, right),
  inset: 10pt,
  stroke: 0.5pt + gray,

  [*Total de Mensajes este Mes*], [#get("messages_this_month")],
  [*Mensajes de Usuarios*], [#get("user_messages_this_month")],
  [*Respuestas del Bot*], [#get("bot_messages_this_month")],
  [*Mensajes de Administradores*], [#get("admin_messages_this_month")],
  [*Promedio Diario*], [#get("avg_messages_per_day")],
)

== Distribución Horaria

#if get("peak_hour") != "" [
*Hora Pico:* #get("peak_hour"):00 hrs (#get("peak_hour_count") mensajes)

#let peak = int(get("peak_hour", default: "0"))
Los usuarios son más activos entre las #get("peak_hour"):00 y las #(peak + 2):00 horas.
]

#pagebreak()

// ============================================
// TOP QUERIES
// ============================================

= Consultas Más Frecuentes

Las siguientes son las preguntas más realizadas por los usuarios durante este mes:

#let top_queries = parse-json(get("top_queries_json", default: "[]"))
#if top_queries.len() > 0 [
#table(
  columns: (1fr, 3fr, 1fr, 1fr),
  align: (center, left, center, center),
  inset: 8pt,
  stroke: 0.5pt + gray,
  table.header(
    [*#*], [*Consulta*], [*Veces*], [*Calidad*]
  ),
  ..for (index, query) in top_queries.enumerate() {
    let quality = if query.has_good_answer { "✓" } else { "⚠" }
    ([#(index + 1)], [#query.query_text], [#str(query.query_count)], [#quality])
  }
)

#v(1em)

*Leyenda:*
- ✓ = Respuesta de buena calidad (similaridad > 0.5)
- ⚠ = Necesita mejorar contenido (similaridad < 0.5)
]

#let queries_needing_attention = parse-json(get("queries_needing_attention_json", default: "[]"))
#if queries_needing_attention.len() > 0 [
== Consultas que Requieren Atención

Las siguientes consultas tienen baja calidad de respuesta y deberían agregarse más contenido a la base de conocimientos:

#for query in queries_needing_attention [
- *"#query.query_text"* (#str(query.query_count) veces, similaridad: #query.avg_similarity)
]
]

#pagebreak()

// ============================================
// KNOWLEDGE BASE
// ============================================

= Base de Conocimientos

== Uso de la Base de Conocimientos

#let top_chunks = parse-json(get("top_chunks_json", default: "[]"))
#if top_chunks.len() > 0 [
=== Fragmentos Más Utilizados

#table(
  columns: (1fr, 2fr, 1fr, 1fr),
  align: (center, left, center, center),
  inset: 8pt,
  stroke: 0.5pt + gray,
  table.header(
    [*#*], [*Documento*], [*Usos*], [*Similaridad*]
  ),
  ..for (index, chunk) in top_chunks.enumerate() {
    ([#(index + 1)], [#chunk.document_title], [#str(chunk.usage_count)], [#chunk.avg_similarity])
  }
)
]

== Estadísticas Generales

#table(
  columns: (2fr, 1fr),
  align: (left, right),
  inset: 10pt,
  stroke: 0.5pt + gray,

  [*Total de Documentos*], [#get("total_documents")],
  [*Total de Fragmentos (Chunks)*], [#get("total_chunks")],
  [*Fragmentos Utilizados*], [#get("chunks_used")],
  [*Fragmentos No Utilizados*], [#get("chunks_never_used")],
  [*Tasa de Cobertura*], [#get("coverage_rate")%],
)

#let coverage = float(get("coverage_rate", default: "0"))
#if coverage < 50.0 [
#box(
  fill: yellow.lighten(80%),
  inset: 1em,
  radius: 5pt,
  width: 100%,
)[
  ⚠ *Recomendación:* La tasa de cobertura es baja (#get("coverage_rate")%). Esto significa que muchos fragmentos de la base de conocimientos no están siendo utilizados. Considere:

  - Revisar y eliminar contenido irrelevante
  - Mejorar la calidad de los embeddings
  - Agregar contenido que responda a las consultas más frecuentes
]
]

#pagebreak()

// ============================================
// SYSTEM PERFORMANCE
// ============================================

= Rendimiento del Sistema

== Tiempos de Respuesta

#table(
  columns: (2fr, 1fr),
  align: (left, right),
  inset: 10pt,
  stroke: 0.5pt + gray,

  [*Tiempo Promedio de Respuesta LLM*], [#get("avg_llm_response_time") ms],
  [*Tiempo de Respuesta P95*], [#get("p95_response_time") ms],
  [*Tiempo de Respuesta P99*], [#get("p99_response_time") ms],
)

== Salud del Sistema

#table(
  columns: (2fr, 1fr),
  align: (left, right),
  inset: 10pt,
  stroke: 0.5pt + gray,

  [*Errores en Últimas 24h*], [#get("errors_last_24h")],
  [*Conversaciones Fallidas*], [#get("failed_conversations")],
  [*Disponibilidad*], [#get("uptime")%],
)

#let errors = int(get("errors_last_24h", default: "0"))
#if errors > 10 [
#box(
  fill: red.lighten(80%),
  inset: 1em,
  radius: 5pt,
  width: 100%,
)[
  ⚠ *Alerta:* Se detectaron #get("errors_last_24h") errores en las últimas 24 horas. Revise los logs del sistema.
]
]

#pagebreak()

// ============================================
// RECOMMENDATIONS
// ============================================

= Recomendaciones

Basado en los datos recopilados este mes, se sugieren las siguientes acciones:

== Optimización de Costos

#let cost_conv = float(get("cost_per_conversation", default: "0"))
#if cost_conv > 0.05 [
- El costo por conversación ($#get("cost_per_conversation")) es alto. Considere:
  - Reducir el tamaño del contexto del prompt
  - Limitar el número de chunks recuperados
  - Ajustar los parámetros del modelo (temperatura, max_tokens)
]

#let avg_tokens = float(get("avg_tokens_per_conversation", default: "0"))
#if avg_tokens > 5000 [
- El promedio de tokens por conversación (#get("avg_tokens_per_conversation")) es elevado
- Revise si el sistema está enviando información innecesaria al LLM
]

== Mejora de Contenidos

#let intervention = float(get("admin_intervention_rate", default: "0"))
#if intervention > 15.0 [
- La tasa de intervención del administrador (#get("admin_intervention_rate")%) indica que el bot no puede responder muchas consultas
- Priorice agregar contenido para las consultas más frecuentes sin buena respuesta
]

#let queries_attn = parse-json(get("queries_needing_attention_json", default: "[]"))
#if queries_attn.len() > 0 [
- Agregue o mejore contenido para las siguientes consultas:
#for query in queries_attn [
  - "#query.query_text"
]
]

== Base de Conocimientos

#let coverage_rec = float(get("coverage_rate", default: "0"))
#if coverage_rec < 40.0 [
- La cobertura de la base de conocimientos es baja (#get("coverage_rate")%)
- Elimine fragmentos no utilizados y agregue contenido relevante
]

#let chunks_unused = int(get("chunks_never_used", default: "0"))
#if chunks_unused > 0 [
- Hay #get("chunks_never_used") fragmentos que nunca han sido utilizados
- Revise y actualice o elimine este contenido
]

== Experiencia de Usuario

#let avg_msgs = float(get("avg_messages_per_conversation", default: "0"))
#if avg_msgs > 10.0 [
- El promedio de #get("avg_messages_per_conversation") mensajes por conversación es alto
- Considere mejorar las respuestas para que sean más completas y directas
]

#pagebreak()

// ============================================
// CONCLUSIONS
// ============================================

= Conclusiones

== Resumen del Período

Durante #get("month_year"), el chatbot del Instituto Superior Tecnológico Sudamericano atendió a *#get("active_users_this_month") usuarios activos* a través de *#get("conversations_this_month") conversaciones*, con un costo total de *$#get("cost_this_month")*.

== Indicadores Clave

#let satisfaction = 100.0 - float(get("admin_intervention_rate", default: "0"))
- ✓ *Usuarios satisfechos:* #calc.round(satisfaction, digits: 1)% de conversaciones resueltas sin intervención
- ✓ *Disponibilidad:* #get("uptime")%
- ✓ *Eficiencia:* $#get("cost_per_conversation") por conversación

#let intervention_conc = float(get("admin_intervention_rate", default: "0"))
#if intervention_conc > 20.0 [
- ⚠ *Área de mejora:* Tasa de intervención del administrador alta
]

#let coverage_conc = float(get("coverage_rate", default: "0"))
#if coverage_conc < 50.0 [
- ⚠ *Área de mejora:* Cobertura de la base de conocimientos baja
]

== Próximos Pasos

1. Implementar las recomendaciones sugeridas en este reporte
2. Monitorear continuamente las métricas de costo y calidad
3. Actualizar la base de conocimientos mensualmente
4. Revisar consultas con baja calidad de respuesta

#v(2cm)

#align(center)[
  #line(length: 60%, stroke: 0.5pt + gray)
  #v(0.5cm)
  #text(size: 10pt, fill: gray)[
    Fin del Reporte

    Este reporte fue generado automáticamente por el sistema de analíticas del chatbot.

    Para más información, contacte al administrador del sistema.
  ]
]
